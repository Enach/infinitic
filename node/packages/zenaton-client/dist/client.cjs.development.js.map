{"version":3,"file":"client.cjs.development.js","sources":["../src/client.ts"],"sourcesContent":["import { ClientOpts as PulsarClientOpts, Client as PulsarClient, Producer as PulsarProducer} from 'pulsar-client';\nimport {AvroForEngineMessage, DispatchJobMessage, ForEngineMessage} from '@zenaton/messages';\nimport { v4 as uuid } from 'uuid';\n\nexport interface ClientOpts {\n  pulsar: {\n    client: PulsarClientOpts;\n  };\n}\n\nexport class Client {\n  private opts: ClientOpts;\n  private pulsarClient?: PulsarClient;\n  private pulsarProducer?: PulsarProducer;\n\n  constructor(opts: Partial<ClientOpts> = {}) {\n    this.opts = Object.assign(\n      {\n        pulsar: {\n          client: {},\n        },\n      },\n      opts\n    );\n  }\n\n  async dispatchTask(name: string, input: any) {\n    const jobId = uuid();\n    const message: DispatchJobMessage = {\n      jobId,\n      type: 'DispatchJob',\n      DispatchJob: {\n        jobId,\n        sentAt: Date.now(),\n        jobName: name,\n        jobData: Buffer.from(JSON.stringify(input)),\n        workflowId: null\n      },\n    };\n\n    this.dispatchForEngineMessage(message)\n  }\n\n  async dispatchForEngineMessage(message: ForEngineMessage) {\n    if (!this.pulsarClient) {\n      this.pulsarClient = new PulsarClient(this.opts.pulsar.client);\n    }\n    if (!this.pulsarProducer) {\n      this.pulsarProducer = await this.pulsarClient.createProducer({\n        topic: 'persistent://public/default/tasks-engine',\n        sendTimeoutMs: 30000,\n        batchingEnabled: false,\n      });\n    }\n    await this.pulsarProducer.send({\n      data: AvroForEngineMessage.toBuffer(message),\n    });\n  }\n}"],"names":["Client","constructor","opts","Object","assign","pulsar","client","dispatchTask","name","input","jobId","uuid","message","type","DispatchJob","sentAt","Date","now","jobName","jobData","Buffer","from","JSON","stringify","workflowId","dispatchForEngineMessage","pulsarProducer","send","data","AvroForEngineMessage","toBuffer","pulsarClient","PulsarClient","createProducer","topic","sendTimeoutMs","batchingEnabled"],"mappings":";;;;;;;;MAUaA;AAKXC,EAAAA,YAAYC,OAA4B;AACtC,SAAKA,IAAL,GAAYC,MAAM,CAACC,MAAP,CACV;AACEC,MAAAA,MAAM,EAAE;AACNC,QAAAA,MAAM,EAAE;AADF;AADV,KADU,EAMVJ,IANU,CAAZ;AAQD;;AAEKK,EAAAA,aAAaC,MAAcC;;oBAc/B;;AAbA,YAAMC,KAAK,GAAGC,OAAI,EAAlB;AACA,YAAMC,OAAO,GAAuB;AAClCF,QAAAA,KADkC;AAElCG,QAAAA,IAAI,EAAE,aAF4B;AAGlCC,QAAAA,WAAW,EAAE;AACXJ,UAAAA,KADW;AAEXK,UAAAA,MAAM,EAAEC,IAAI,CAACC,GAAL,EAFG;AAGXC,UAAAA,OAAO,EAAEV,IAHE;AAIXW,UAAAA,OAAO,EAAEC,MAAM,CAACC,IAAP,CAAYC,IAAI,CAACC,SAAL,CAAed,KAAf,CAAZ,CAJE;AAKXe,UAAAA,UAAU,EAAE;AALD;AAHqB,OAApC;;AAYA,YAAKC,wBAAL,CAA8Bb,OAA9B;;;AACD;;;;;AAEKa,EAAAA,yBAAyBb;;qBACxB;;;+BAUC,OAAKc,cAAL,CAAoBC,IAApB,CAAyB;AAC7BC,UAAAA,IAAI,EAAEC,6BAAoB,CAACC,QAArB,CAA8BlB,OAA9B;AADuB,SAAzB;;;AAVN,UAAI,CAAC,OAAKmB,YAAV,EAAwB;AACtB,eAAKA,YAAL,GAAoB,IAAIC,mBAAJ,CAAiB,OAAK9B,IAAL,CAAUG,MAAV,CAAiBC,MAAlC,CAApB;AACD;;;YACG,CAAC,OAAKoB;iCACoB,OAAKK,YAAL,CAAkBE,cAAlB,CAAiC;AAC3DC,YAAAA,KAAK,EAAE,0CADoD;AAE3DC,YAAAA,aAAa,EAAE,KAF4C;AAG3DC,YAAAA,eAAe,EAAE;AAH0C,WAAjC;AAA5B,mBAAKV,cAAL;;;;;;AASH;;;;;;;;;"}